generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * =========================
 * USER & AUTH
 * =========================
 */

model User {
  id           String  @id @default(uuid())
  name         String?
  nickname     String
  phoneNumber  String  @unique
  passwordHash String

  avatarUrl String?

  points Int @default(0)

  address     String?
  addressNote String?

  role           Role    @default(USER)
  isVerified     Boolean @default(false)
  sessionVersion Int     @default(1)
  isActive       Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  stoves          Stove[]
  cart            Cart?
  ordersAsClient  Order[]        @relation("ClientRelation")
  ordersAsShipper Order[]        @relation("ShipperRelation")
  refreshTokens   RefreshToken[]
}

/**
 * =========================
 * REFRESH TOKEN
 * =========================
 */

model RefreshToken {
  id                  String  @id @default(uuid())
  userId              String
  tokenHash           String  @unique
  replacedByTokenHash String?

  revoked    Boolean   @default(false)
  expiresAt  DateTime
  lastUsedAt DateTime?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/**
 * =========================
 * OTP
 * =========================
 */

model PhoneOtp {
  id        String   @id @default(uuid())
  phone     String
  code      String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([phone, code])
}

/**
 * =========================
 * CATEGORY
 * =========================
 */

model Category {
  id   String @id @default(uuid())
  name String @unique

  tags ProductTag[]

  products Product[]
}

/**
 * =========================
 * PRODUCT
 * =========================
 */

model Product {
  id              String  @id @default(uuid())
  productName     String
  currentPrice    Int
  pointValue      Int     @default(0)
  previewImageUrl String?

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  tags ProductTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  cartItems  CartItem[]
  orderItems OrderItem[]
  stoves     Stove[]
}

/**
 * =========================
 * STOVE
 * =========================
 */

model Stove {
  id     String @id @default(uuid())
  name   String @default("")
  userId String

  productId       String? // gas đang bind (có thể chưa bind)
  address         String
  note            String?
  houseImage      String[]
  houseImageCount Int      @default(0)

  // thói quen đặt gas
  defaultProductQuantity Int @default(1)

  defaultPromoChoice    PromoChoiceType?
  defaultPromoProductId String? // nếu chọn quà hiện vật

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user    User     @relation(fields: [userId], references: [id])
  product Product? @relation(fields: [productId], references: [id])
  orders  Order[]
  carts   Cart[]

  @@index([userId])
}

/**
 * =========================
 * CART (1 USER = 1 CART)
 * =========================
 */

model Cart {
  id     String @id @default(uuid())
  userId String @unique

  stoveId  String? // có thể chưa chọn bếp
  type     CartType @default(NORMAL)
  isActive Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user  User   @relation(fields: [userId], references: [id])
  stove Stove? @relation(fields: [stoveId], references: [id])

  items CartItem[]
}

/**
 * =========================
 * CART ITEM
 * =========================
 */

model CartItem {
  id        String @id @default(uuid())
  cartId    String
  productId String

  quantity Int
  type     CartItemType

  parentItemId String?
  parentItem   CartItem?  @relation("CartItemParent", fields: [parentItemId], references: [id])
  children     CartItem[] @relation("CartItemParent")

  payByPoints Boolean @default(false)
  earnPoints  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

/**
 * =========================
 * ORDER
 * =========================
 */

model Order {
  id      String    @id @default(uuid())
  userId  String
  stoveId String
  type    OrderType @default(NORMAL)

  subtotal       Int
  discountAmount Int     @default(0)
  shipFee        Int     @default(0)
  totalPrice     Int
  shipperId      String? // ✅ THÊM: nullable

  confirmedAt     DateTime?
  deliveredAt     DateTime?
  cancelledReason String?

  status OrderStatus @default(PENDING)
  note   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user       User             @relation("ClientRelation", fields: [userId], references: [id])
  shipper    User?            @relation("ShipperRelation", fields: [shipperId], references: [id])
  stove      Stove            @relation(fields: [stoveId], references: [id])
  items      OrderItem[]
  promotions OrderPromotion[]
}

/**
 * =========================
 * ORDER ITEM
 * =========================
 */

model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  productId String

  quantity  Int
  unitPrice Int

  type OrderItemType

  parentItemId String?
  parentItem   OrderItem?  @relation("OrderItemParent", fields: [parentItemId], references: [id])
  children     OrderItem[] @relation("OrderItemParent")

  payByPoints Boolean @default(false)
  earnPoints  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

/**
 * =========================
 * PROMOTION
 * =========================
 */
model Promotion {
  id          String  @id @default(uuid())
  name        String
  description String?

  startAt  DateTime
  endAt    DateTime
  isActive Boolean  @default(true)

  priority Int @default(0) // xử lý khi nhiều promo cùng lúc

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  conditions PromotionCondition[]
  actions    PromotionAction[]
  orders     OrderPromotion[]
}

model PromotionCondition {
  id          String @id @default(uuid())
  promotionId String

  type  PromotionConditionType
  value String? // JSON string hoặc scalar

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@index([promotionId])
}

model PromotionAction {
  id          String @id @default(uuid())
  promotionId String

  type        PromotionActionType
  value       Int? // % hoặc số tiền
  maxDiscount Int?

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@index([promotionId])
}

model OrderPromotion {
  id          String @id @default(uuid())
  orderId     String
  promotionId String

  discountAmount Int     @default(0)
  freeShip       Boolean @default(false)
  bonusPoint     Int     @default(0)

  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  promotion Promotion @relation(fields: [promotionId], references: [id])

  @@index([orderId])
}

/**
 * =========================
 * ENUMS
 * =========================
 */

enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  WAITING_CUSTOMER_CONFIRM
  READY
  DELIVERING
  COMPLETED
  CANCELLED
}

enum OrderType {
  NORMAL
  EXCHANGE
}

enum CartType {
  NORMAL
  EXCHANGE
}

enum CartItemType {
  GAS // sản phẩm chính từ stove bind
  NORMAL_PRODUCT // mua thêm ngoài gas
  PROMO_BONUS // quà khuyến mãi đi kèm gas
  POINT_EXCHANGE // quà đổi bằng điểm
}

enum OrderItemType {
  GAS
  NORMAL_PRODUCT
  PROMO_BONUS
  POINT_EXCHANGE
}

enum ProductTag {
  BINDABLE // sản phẩm cốt lõi (gas)
  POINT_EARNABLE // được tích điểm
  POINT_EXCHANGABLE // mua bằng điểm
  FREE_SHIP // miễn ship
  PROMO_ELIGIBLE // tham gia campaign
}

enum PromotionConditionType {
  PRODUCT_TAG
  CATEGORY
  MIN_SUBTOTAL
  ORDER_TYPE
}

enum PromotionActionType {
  DISCOUNT_PERCENT
  DISCOUNT_AMOUNT
  FREE_SHIP
  BONUS_POINT
}

enum PromoChoiceType {
  GIFT_PRODUCT // chọn quà hiện vật
  DISCOUNT_CASH // giảm 10k
  BONUS_POINT // +1000 điểm
}
