generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String  @id @default(uuid())
  name         String?
  nickname     String
  phoneNumber  String  @unique
  passwordHash String

  avatarUrl String?
  points    Int     @default(0)

  address     String?
  addressNote String?

  role           Role    @default(USER)
  isVerified     Boolean @default(false)
  sessionVersion Int     @default(1)
  isActive       Boolean @default(true)

  tags UserTag[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  stoves          Stove[]
  ordersAsClient  Order[]        @relation("ClientRelation")
  ordersAsShipper Order[]        @relation("ShipperRelation")
  refreshTokens   RefreshToken[]
}

model RefreshToken {
  id                  String  @id @default(uuid())
  userId              String
  tokenHash           String  @unique
  replacedByTokenHash String?

  revoked    Boolean   @default(false)
  expiresAt  DateTime
  lastUsedAt DateTime?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PhoneOtp {
  id        String   @id @default(uuid())
  phone     String
  code      String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([phone, code])
}

model Category {
  id   String @id @default(uuid())
  name String @unique

  tags     ProductTag[]
  products Product[]
}

model Product {
  id              String  @id @default(uuid())
  productName     String
  currentPrice    Int
  pointValue      Int     @default(0)
  previewImageUrl String?
  description     String  @default("")

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  tags ProductTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  cartItems   CartItem[]
  orderItems  OrderItem[]
  boundStoves Stove[]     @relation("StoveGasProduct")
  promoStoves Stove[]     @relation("StovePromoProduct")
}

model Service {
  id          String  @id @default(uuid())
  name        String
  description String?

  basePrice Int     @default(0)
  isActive  Boolean @default(true)

  category ServiceCategory

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  cartItems  CartServiceItem[]
  orderItems OrderServiceItem[]
}

enum ServiceCategory {
  REPAIR
  INSPECTION
  CLEANING
  INSTALLATION
}

model Stove {
  id     String @id @default(uuid())
  name   String @default("")
  userId String

  productId       String?
  address         String
  note            String?
  houseImage      String[] @default([])
  houseImageCount Int      @default(0)

  defaultProductQuantity Int @default(1)

  defaultPromoChoice    PromoChoiceType?
  defaultPromoProductId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user         User     @relation(fields: [userId], references: [id])
  product      Product? @relation("StoveGasProduct", fields: [productId], references: [id])
  promoProduct Product? @relation("StovePromoProduct", fields: [defaultPromoProductId], references: [id])

  cart              Cart?
  orders            Order[]
  cartServiceItems  CartServiceItem[]
  orderServiceItems OrderServiceItem[]

  @@index([userId])
}

model Cart {
  id       String   @id @default(uuid())
  stoveId  String   @unique
  type     CartType @default(NORMAL)
  isActive Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  stove Stove @relation(fields: [stoveId], references: [id], onDelete: Cascade)

  items        CartItem[]
  serviceItems CartServiceItem[]
}

model CartItem {
  id        String @id @default(uuid())
  cartId    String
  productId String

  quantity Int
  type     CartItemType

  parentItemId String?
  parentItem   CartItem?  @relation("CartItemParent", fields: [parentItemId], references: [id])
  children     CartItem[] @relation("CartItemParent")

  payByPoints Boolean @default(false)
  earnPoints  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

model CartServiceItem {
  id        String @id @default(uuid())
  cartId    String
  serviceId String
  stoveId   String

  quantity Int     @default(1)
  price    Int
  note     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id])
  stove   Stove   @relation(fields: [stoveId], references: [id])

  @@index([cartId])
  @@index([stoveId])
}

model Order {
  id      String    @id @default(uuid())
  userId  String
  stoveId String
  type    OrderType @default(NORMAL)

  subtotal       Int
  discountAmount Int     @default(0)
  shipFee        Int     @default(0)
  totalPrice     Int
  shipperId      String?

  confirmedAt     DateTime?
  deliveredAt     DateTime?
  cancelledReason String?

  status OrderStatus @default(PENDING)
  note   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user    User  @relation("ClientRelation", fields: [userId], references: [id])
  shipper User? @relation("ShipperRelation", fields: [shipperId], references: [id])
  stove   Stove @relation(fields: [stoveId], references: [id])

  items        OrderItem[]
  promotions   OrderPromotion[]
  serviceItems OrderServiceItem[]
}

model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  productId String

  quantity  Int
  unitPrice Int

  type OrderItemType

  parentItemId String?
  parentItem   OrderItem?  @relation("OrderItemParent", fields: [parentItemId], references: [id])
  children     OrderItem[] @relation("OrderItemParent")

  payByPoints Boolean @default(false)
  earnPoints  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

model OrderServiceItem {
  id        String @id @default(uuid())
  orderId   String
  serviceId String
  stoveId   String

  serviceName String
  unitPrice   Int
  quantity    Int
  note        String?

  status ServiceStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id])
  stove   Stove   @relation(fields: [stoveId], references: [id])

  @@index([orderId])
  @@index([stoveId])
}

model Promotion {
  id          String  @id @default(uuid())
  name        String
  description String?

  startAt  DateTime
  endAt    DateTime
  isActive Boolean  @default(true)

  priority Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  conditions PromotionCondition[]
  actions    PromotionAction[]
  orders     OrderPromotion[]
}

model PromotionCondition {
  id          String                 @id @default(uuid())
  promotionId String
  type        PromotionConditionType
  value       String?

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@index([promotionId])
}

model PromotionAction {
  id          String              @id @default(uuid())
  promotionId String
  type        PromotionActionType
  value       Int?
  maxDiscount Int?

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@index([promotionId])
}

model OrderPromotion {
  id          String @id @default(uuid())
  orderId     String
  promotionId String

  discountAmount Int     @default(0)
  freeShip       Boolean @default(false)
  bonusPoint     Int     @default(0)

  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  promotion Promotion @relation(fields: [promotionId], references: [id])

  @@index([orderId])
}

enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  WAITING_CUSTOMER_CONFIRM
  READY
  DELIVERING
  COMPLETED
  CANCELLED
}

enum OrderType {
  NORMAL
  EXCHANGE
}

enum CartType {
  NORMAL
  EXCHANGE
}

enum CartItemType {
  GAS
  NORMAL_PRODUCT
  PROMO_BONUS
  POINT_EXCHANGE
  GIFT_PRODUCT
}

enum OrderItemType {
  GAS
  NORMAL_PRODUCT
  PROMO_BONUS
  POINT_EXCHANGE
  GIFT_PRODUCT
}

enum ProductTag {
  BINDABLE
  POINT_EARNABLE
  POINT_EXCHANGABLE
  FREE_SHIP
  PROMO_ELIGIBLE
}

enum PromotionConditionType {
  PRODUCT_TAG
  CATEGORY
  MIN_SUBTOTAL
  ORDER_TYPE
}

enum PromotionActionType {
  DISCOUNT_PERCENT
  DISCOUNT_AMOUNT
  FREE_SHIP
  BONUS_POINT
}

enum PromoChoiceType {
  GIFT_PRODUCT
  DISCOUNT_CASH
  BONUS_POINT
}

enum ServiceStatus {
  PENDING
  CHECKING
  FIXING
  DONE
  CANNOT_FIX
}

enum UserTag {
  BUSINESS
}
