generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/* =========================
   USER & AUTH
========================= */

model User {
  id              String   @id @default(uuid())
  name            String?
  nickname        String
  phoneNumber     String   @unique
  password        String

  points          Int      @default(0)

  address         String?
  addressNote     String?
  houseImage      String[]
  houseImageCount Int      @default(0)

  role            Role     @default(USER)
  isVerified      Boolean  @default(false)
  sessionVersion  Int      @default(1)
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  stoves          Stove[]
  cart            Cart?
  orders          Order[]
  refreshTokens   RefreshToken[]
}

/* =========================
   REFRESH TOKEN
========================= */

model RefreshToken {
  id                  String   @id @default(uuid())
  userId              String
  tokenHash           String   @unique
  replacedByTokenHash String?

  revoked             Boolean  @default(false)
  expiresAt           DateTime
  lastUsedAt          DateTime?

  createdAt           DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/* =========================
   OTP
========================= */

model PhoneOtp {
  id        String   @id @default(uuid())
  phone     String
  code      String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([phone])
}

/* =========================
   CATEGORY
========================= */

model Category {
  id        String        @id @default(uuid())
  name      String        @unique

  tags      ProductTag[]

  products  Product[]
}

/* =========================
   PRODUCT
========================= */

model Product {
  id           String        @id @default(uuid())
  productName  String
  currentPrice Int
  pointValue   Int           @default(0)

  categoryId   String
  category     Category      @relation(fields: [categoryId], references: [id])

  tags         ProductTag[]  

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @default(now()) @updatedAt

  cartItems    CartItem[]
  orderItems   OrderItem[]
  stoves       Stove[]
}


/* =========================
   STOVE
========================= */

model Stove {
  id        String   @id @default(uuid())
  name      String   @default("")
  userId    String

  productId String?  // gas đang bind (có thể chưa bind)
  address   String
  note      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  product   Product? @relation(fields: [productId], references: [id])
  orders    Order[]
  carts     Cart[]

  @@index([userId])
}

/* =========================
   CART (1 USER = 1 CART)
========================= */

model Cart {
  id        String    @id @default(uuid())
  userId    String    @unique

  stoveId   String?   // có thể chưa chọn bếp
  type      CartType  @default(NORMAL)
  isActive  Boolean   @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now()) @updatedAt

  user      User      @relation(fields: [userId], references: [id])
  stove     Stove?    @relation(fields: [stoveId], references: [id])

  items     CartItem[]
}


/* =========================
   CART ITEM
========================= */

model CartItem {
  id           String       @id @default(uuid())
  cartId       String
  productId    String

  quantity     Int
  type         CartItemType
  payByPoints  Boolean      @default(false)
  earnPoints   Boolean      @default(true)

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @default(now()) @updatedAt

  cart         Cart         @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
}

/* =========================
   ORDER
========================= */

model Order {
  id             String      @id @default(uuid())
  userId         String
  stoveId        String
  type           OrderType   @default(NORMAL)

  subtotal       Int
  discountAmount Int         @default(0)
  shipFee        Int         @default(0)
  totalPrice     Int

  status         OrderStatus @default(PENDING)
  note           String?

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @default(now()) @updatedAt

  user           User        @relation(fields: [userId], references: [id])
  stove          Stove       @relation(fields: [stoveId], references: [id])
  items          OrderItem[]
}

/* =========================
   ORDER ITEM
========================= */

model OrderItem {
  id           String        @id @default(uuid())
  orderId      String
  productId    String

  quantity     Int
  unitPrice   Int

  type         OrderItemType
  payByPoints Boolean       @default(false)
  earnPoints  Boolean       @default(true)

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @default(now()) @updatedAt

  order        Order        @relation(fields: [orderId], references: [id])
  product      Product     @relation(fields: [productId], references: [id])

  @@index([orderId])
}

/* =========================
   ENUMS
========================= */

enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  WAITING_CUSTOMER_CONFIRM
  READY
  DELIVERING
  COMPLETED
  CANCELLED
}

enum OrderType {
  NORMAL
  EXCHANGE
}

enum CartType {
  NORMAL
  EXCHANGE
}

enum CartItemType {
  PRODUCT     
  SERVICE     
  PART        
}

enum OrderItemType {
  PRODUCT
  SERVICE
  PART
}

enum ProductTag {
  BINDABLE              // sản phẩm cốt lõi (gas)
  POINT_EARNABLE        // được tích điểm
  POINT_EXCHANGABLE     // mua bằng điểm
  FREE_SHIP             // miễn ship
  PROMO_ELIGIBLE        // tham gia campaign
}
